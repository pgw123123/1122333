---
- name: Create VPC
  amazon.aws.ec2_vpc_net:
    name: "{{ project_name }}-vpc"
    cidr_block: "{{ vpc_cidr }}"
    region: "{{ aws_region }}"
    dns_support: yes
    dns_hostnames: yes
    tenancy: default
    state: present
    tags: "{{ common_tags | combine({'Name': project_name + '-vpc'}) }}"
  register: vpc_result  # ⚠️ 꼭 확인: 위 줄(tags)보다 왼쪽(모듈 이름과 같은 라인)으로 나와야 합니다!

# ✅ 수정됨: 에러가 나던 msg 방식을 버리고, 전체 내용을 있는 그대로 출력합니다.
- name: Debug VPC Result (RAW DATA)
  debug:
    var: vpc_result

- name: Create Internet Gateway
  amazon.aws.ec2_vpc_igw:
    # ⚠️ 임시 수정: 만약 vpc_result 구조가 다르다면 여기서도 에러가 날 수 있습니다.
    # 일단 Debug 로그를 보기 위해 아래처럼 안전장치를 둡니다.
    vpc_id: "{{ vpc_result.vpc.id | default(vpc_result.id) | default('vpc-error') }}"
    region: "{{ aws_region }}"
    state: present
    tags: "{{ common_tags | combine({'Name': project_name + '-igw'}) }}"
  register: igw

- name: Create Public Subnets
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc_result.vpc.id | default(vpc_result.id) | default('vpc-error') }}"
    region: "{{ aws_region }}"
    az: "{{ item.az }}"
    cidr: "{{ item.cidr }}"
    map_public: yes
    tags: "{{ common_tags | combine({'Name': project_name + '-' + item.suffix}) }}"
  loop:
    - { az: "{{ az_1 }}", cidr: "{{ public_subnet_1_cidr }}", suffix: "pub-sub-1" }
    - { az: "{{ az_2 }}", cidr: "{{ public_subnet_2_cidr }}", suffix: "pub-sub-2" }
  register: public_subnets

- name: Create Private Subnets
  amazon.aws.ec2_vpc_subnet:
    vpc_id: "{{ vpc_result.vpc.id | default(vpc_result.id) | default('vpc-error') }}"
    region: "{{ aws_region }}"
    az: "{{ item.az }}"
    cidr: "{{ item.cidr }}"
    map_public: no
    tags: "{{ common_tags | combine({'Name': project_name + '-' + item.suffix}) }}"
  loop:
    - { az: "{{ az_1 }}", cidr: "{{ private_subnet_1_cidr }}", suffix: "pri-sub-1" }
    - { az: "{{ az_2 }}", cidr: "{{ private_subnet_2_cidr }}", suffix: "pri-sub-2" }
  register: private_subnets

- name: Allocate Elastic IP for NAT Gateway
  amazon.aws.ec2_eip:
    region: "{{ aws_region }}"
    in_vpc: yes
    reuse_existing_ip_allowed: yes
    tags: "{{ common_tags | combine({'Name': project_name + '-nat-eip'}) }}"
  register: nat_eip

- name: Create NAT Gateway (in Public Subnet 1)
  amazon.aws.ec2_vpc_nat_gateway:
    state: present
    subnet_id: "{{ public_subnets.results[0].subnet.id }}"
    allocation_id: "{{ nat_eip.allocation_id }}"
    region: "{{ aws_region }}"
    wait: yes
    tags: "{{ common_tags | combine({'Name': project_name + '-nat'}) }}"
  register: nat_gateway

- name: Create Public Route Table
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_result.vpc.id | default(vpc_result.id) | default('vpc-error') }}"
    region: "{{ aws_region }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ igw.gateway_id }}"
    subnets: "{{ public_subnets.results | map(attribute='subnet.id') | list }}"
    tags: "{{ common_tags | combine({'Name': project_name + '-pub-rt'}) }}"

- name: Create Private Route Table (Routes to NAT)
  amazon.aws.ec2_vpc_route_table:
    vpc_id: "{{ vpc_result.vpc.id | default(vpc_result.id) | default('vpc-error') }}"
    region: "{{ aws_region }}"
    routes:
      - dest: 0.0.0.0/0
        gateway_id: "{{ nat_gateway.nat_gateway_id }}"
    subnets: "{{ private_subnets.results | map(attribute='subnet.id') | list }}"
    tags: "{{ common_tags | combine({'Name': project_name + '-pri-rt'}) }}"