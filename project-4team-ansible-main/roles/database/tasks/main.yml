---
############################################
# 1. ì •ë³´ ì¡°íšŒ
############################################

- name: Debug Project Name
  debug:
    msg: "project_name = [{{ project_name }}]"

- name: Get VPC Info
  amazon.aws.ec2_vpc_net_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Name": "{{ project_name }}-vpc"
  register: target_vpc_info

- name: Get Private Subnets
  amazon.aws.ec2_vpc_subnet_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Name": "{{ project_name }}-pri-sub-*"
  register: private_subnets_info

- name: Get DB Security Group
  amazon.aws.ec2_security_group_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Name": "{{ project_name }}-db-sg"
  register: db_sg_info

############################################
# 1-1. ì•ˆì „ ì¥ì¹˜
############################################

- name: Verify Resources Exist
  fail:
    msg: "VPC / Subnet / DB Security Group ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íƒœê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
  when:
    - target_vpc_info.vpcs | length == 0
    - private_subnets_info.subnets | length == 0
    - db_sg_info.security_groups | length == 0

############################################
# 2. DB Subnet Group
############################################

- name: Create DB Subnet Group
  amazon.aws.rds_subnet_group:
    state: present
    name: "{{ project_name | trim }}-db-subnet-group"
    description: "Subnet Group for {{ project_name }} RDS"
    region: "{{ aws_region }}"
    subnets: "{{ private_subnets_info.subnets | map(attribute='subnet_id') | list }}"
    tags:
      Name: "{{ project_name | trim }}-db-subnet-group"

############################################
# 3. RDS Instance (ğŸ”¥ DBName ì™„ì „ ìˆ˜ì •)
############################################

- name: Create RDS Instance
  amazon.aws.rds_instance:
    id: "{{ project_name | trim }}-rds"

    # ğŸ”¥ ë¬´ì¡°ê±´ ë¬¸ìë¡œ ì‹œì‘ + ì˜ìˆ«ìë§Œ
    db_name: "team4db"

    db_instance_class: "{{ db_instance_class }}"
    engine: mysql
    engine_version: "8.0"

    username: "{{ db_user }}"
    password: "{{ db_password }}"
    port: 3306
    region: "{{ aws_region }}"

    vpc_security_group_ids: "{{ db_sg_info.security_groups | map(attribute='group_id') | list }}"
    db_subnet_group_name: "{{ project_name | trim }}-db-subnet-group"

    publicly_accessible: no
    multi_az: no

    allocated_storage: 20
    storage_type: gp2

    backup_retention_period: 1
    skip_final_snapshot: yes
    wait: yes
