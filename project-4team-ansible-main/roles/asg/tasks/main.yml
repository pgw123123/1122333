---
# [수정 1] 네트워크 Role과 독립적으로 실행되도록 VPC ID를 이름으로 직접 조회합니다.
- name: Get VPC Info
  amazon.aws.ec2_vpc_net_info:
    region: "{{ aws_region }}"
    filters:
      "tag:Name": "{{ project_name }}-vpc"
  register: target_vpc_info

- name: Set VPC ID Variable
  set_fact:
    target_vpc_id: "{{ target_vpc_info.vpcs[0].vpc_id }}"

# [수정 2] 이름 규칙 통일 (4team-alb-sg)
- name: Create Security Group for ALB (Public)
  amazon.aws.ec2_group:
    name: "{{ project_name }}-alb-sg"
    description: "Allow HTTP/HTTPS from everywhere"
    vpc_id: "{{ target_vpc_id }}"
    region: "{{ aws_region }}"
    tags: "{{ common_tags | combine({'Name': project_name + '-alb-sg'}) }}"
    rules:
      - proto: tcp
        from_port: 80
        to_port: 80
        cidr_ip: 0.0.0.0/0
      - proto: tcp
        from_port: 443
        to_port: 443
        cidr_ip: 0.0.0.0/0
  register: alb_sg

- name: Create Security Group for App Server (Private)
  amazon.aws.ec2_group:
    name: "{{ project_name }}-app-sg"
    description: "Allow traffic from ALB"
    vpc_id: "{{ target_vpc_id }}"
    region: "{{ aws_region }}"
    tags: "{{ common_tags | combine({'Name': project_name + '-app-sg'}) }}"
    rules:
      - proto: tcp
        from_port: 8080
        to_port: 8080
        group_id: "{{ alb_sg.group_id }}" # ALB에서 오는 트래픽만 허용
      
  #     # [수정 3] SSH는 보안상 Bastion이나 특정 IP만 여는 게 좋지만, 일단 개발용으로 둡니다.
  #     # SSM을 쓴다면 이 규칙은 사실 없어도 됩니다. (나중에 삭제 추천)
  #     - proto: tcp
  #       from_port: 22
  #       to_port: 22
  #       cidr_ip: "0.0.0.0/0"
  # register: app_sg

- name: Create Security Group for RDS
  amazon.aws.ec2_group:
    name: "{{ project_name }}-db-sg"
    description: "Allow traffic from App Server and On-premise"
    vpc_id: "{{ target_vpc_id }}"
    region: "{{ aws_region }}"
    tags: "{{ common_tags | combine({'Name': project_name + '-db-sg'}) }}"
    rules:
      # 앱 서버에서 접근 허용
      - proto: tcp
        from_port: 3306
        to_port: 3306
        group_id: "{{ app_sg.group_id }}"

      # [수정 4 - ⭐ 킬링 포인트] 온프레미스(VPN)에서의 접근 허용
      # 이게 있어야 DB Replication이 가능합니다.
      - proto: tcp
        from_port: 3306
        to_port: 3306
        cidr_ip: "{{ onprem_cidr }}" 
  register: db_sg

- name: Debug Security Group IDs
  debug:
    msg: 
      - "ALB SG: {{ alb_sg.group_id }}"
      - "APP SG: {{ app_sg.group_id }}"
      - "DB SG: {{ db_sg.group_id }}"